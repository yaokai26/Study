# EJB/RMI/RPC 学习
-------
## 一、EJB是什么？
   EJB是什么？通俗的讲，EJB就是把你编写的软件中那些需要执行指定的任务的类，不放到客户端软件上了，而是给他打包放到一个服务器上。没错，EJB就是将那些“类”放到一个服务器上，用C/S形式的软件客户端对服务器上的“类”进行调用。
   注意：EJB可以进行远程调用，但是不能够跨语言。webService可以看做是异构系统，异构语言系统通信的一个标准。

### EJB概念的剖析
   商务软件的核心是它的业务逻辑，业务逻辑抽象了整个商务过程的流程，并使用计算机语言将他实现。J2EE对于这个问题的处理方法是将这业务逻辑从客户端软件中抽离出来，封装在一个组件中，这个组件运行在一个独立的服务器上，客户端软件通过网络调用服务器上的组件来实现业务逻辑，而客户端软件的功能单纯到只负责发送调用请求和显示处理结果。在J2EE中，这个运行在独立服务器上，并封装了业务逻辑的组件就是EJB(Enterprise Java Bean）。
   
    剖析1：所谓的“业务逻辑”
    所谓的业务逻辑我们可以理解成执行特定任务的“类”
    剖析2：所谓“将业务逻辑从客户端软件中抽取出来，封装在组件中...运行在一个独立的服务器上”
    其实就是把原来放到客户端的“类”，拿出来不放到客户端了，放到一个组件中，并将这个组件放到一个服务器上去运行。】
    
    什么情况不要使用EJB?
    1、较为简单的Web应用
    2、需要与其他服务程序配合使用的应用，但调用或返回的自定义的网络协议可以解决的应用程序
    3、较多人并发的C/S结构的应用程序
   
### EJB的底层实现技术
   EJB是运行在独立服务器上的组件，客户端通过网络对EJB对象进行调用，在JAVA中，能够实现远程对象调用的技术是RMI，而EJB技术基础正是RMI。
   
## 二、什么是RMI？
    在说RMI之前先理解两个名词：对象的序列化、分布式计算与RPC。
    名词1：对象的序列化
    对象的序列化就是将对象状态转换成字节流和从字节流恢复对象。将对象转换成字节流之后，可以用java.io中的各种字节流将其保存到文件中，或者通过网络连接将对象数据发送到另外一个主机。
    名词2：分布式计算与RPC
    远程过程调用，说白了就是本地计算机调用远程计算机上的一个函数。
    名词3：二者结合就是RMI
    RMI：远程方法调用，利用Java对象序列化的机制实现分布式计算，实现远程类对象的实例化和调用的方法。说清楚点就是利用对象的序列化来实现远程调用。
    
   
### 总结 
    EJB实现原理：就是把原来放在客户端实现的代码放到服务器端，依靠RMI来进行通信
    RMI原理：利用Java对象可序列化机制实现分布式计算
    服务器集群：通过RMI的通信，连接不同功能模块的服务器，以实现一个完整的功能
    
## 什么是RPC？
    RPC：远程过程调用，可以由不同的语言实现。维基百科解释----RPC指在分布式环境下，一个计算机程序能调用另一个地址空间里的方法（不同地址空间通常指局域网下的另一台计算机），但是编码的形式就像调用一个本地方法一样，程序员不用去关心背后的细节。
    
### RPC和RMI的区别
    1、RPC更像一种协议，可以跨语言实现，而RMI仅支持Java，需要双方都运行在JVM中；
    2、RPC通过传入class和MethodName的形式利用反射和代理类调用方法；RMI需要依靠方法签名去lookUp，找到了该方法之后调用它；
    3、RMI可以Java对象和基本数据类型，而RPC通常借助不同的序列化协议来进行网络传输，有解码的过程。
    
### RPC服务的注册与发现
   RPC远程调用过程中，存在两个角色，一个是服务提供者，一个是服务消费者，如何让别人使用我们的服务，就需要告知使用者知道服务的IP和端口。如何自动告知，就使用zookeeper实现服务自动注册与发现！
   
    1、注册中心：用于服务端注册远程服务以及客户端发现服务
    2、服务端：对外提供后台服务，将自己的服务信息注册到注册中心
    3、客户端：从注册中心获取远程服务的注册信息，然后进行远程过程调用
   
   目前主要的注册中心可以借由zookeeper,eureka,consul,etcd等开源框架实现。

#### 服务注册
   首先需要把服务注册到注册中心，其实就是在注册中心进行一个登记，注册中心存储了该服务的IP、端口、调用方式(协议、序列化方式)等。在zookeeper中，进行服务注册，实际上就是在zookeeper中创建了znode节点，该节点存储了上面所说的服务信息。该节点承担着重要的职责，它由服务提供者创建，以供消费者获取节点信息，从而定位到服务提供者真正网络拓扑位置以及得知如何调用。
   
#### 服务发现
   服务消费者在第一次调用服务时，会通过注册中心找到对应服务的IP地址列表，并缓存到本地，以供后续使用。当消费者调用服务时，不会再去服务中心，而是直接通过负载均衡算法从IP列表中取出服务提供者的服务器调用服务。
   
#### 感知服务下线
    1、临时节点+长连接
    在zookeeper中存在持久化节点和临时节点两个概念。持久化节点一经创建，只要不主动删除，便会一直持久化存在。临时节点的生命周期则是和客户端的连接同生共死的，应用连接到zookeeper时创建一个连接，使用长连接维持会话，这样无论何种方式服务发生下线，zookeeper都可以感知到，进而删除临时节点，所以zookeeper的这一特性和服务下线的需求契合比较好，所以临时节点被广泛应用。
    2、主动下线+心跳检测
    在eureka中，会有eureka-server和eureka-client两个角色，eureka-server保存注册信息，等同于zookeeper，当eureka-client需要关闭时，会发送一个通知给eureka-server，从而让eureka-server自己删除这个节点，但是如果遇到断网断点这种情况，就需要给eureka-server增加心跳检测功能，它会为服务提供者进行探测，比如每30秒发送一个心跳，如果三次心跳结果都没有返回值，就认为该服务已经下线。
    3、注册中心对比
    zookeeper本身是一个分布式协调组件，并不是为注册服务而生，server端注册一个服务节点，client端不需要同一时刻拿到完全一样的服务列表，只需要最终一致性即可。在跨IDC，多数据中心等场景下，consul发挥了很大的优势，euraka是ap注册中心，并且是spring cloud默认使用的组件，spring cloud eureka较为贴近spring cloud生态。

